-- ============================================================
-- HEROES OF SHADY GROVE - SUPABASE SCHEMA & TEST DATA v1.0.8 (FINAL FIX 3)
-- Execute this entire script at once.
-- ============================================================

--
-- STEP 1: CLEANUP (DROPPING EXISTING TABLES WITH CASCADE)
-- The CASCADE keyword resolves dependency issues from other tables (like guilds/quests/mail).
--

DROP TABLE IF EXISTS public.hosg_character_skills CASCADE;
DROP TABLE IF EXISTS public.hosg_character_equipment CASCADE;
DROP TABLE IF EXISTS public.hosg_character_items CASCADE;
DROP TABLE IF EXISTS public.hosg_characters CASCADE; 
DROP TABLE IF EXISTS public.hosg_npc_spawns CASCADE;
DROP TABLE IF EXISTS public.hosg_npc_templates CASCADE;
DROP TABLE IF EXISTS public.hosg_skill_templates CASCADE;
DROP TABLE IF EXISTS public.hosg_item_templates CASCADE;


--
-- STEP 2: CREATE TABLES (ALL DEFINITIONS CORRECTED)
--

-- Table structure for hosg_item_templates (FIXED)
CREATE TABLE IF NOT EXISTS public.hosg_item_templates (
    id integer NOT NULL PRIMARY KEY,
    code character varying NOT NULL,
    name character varying NOT NULL,
    description text,
    item_type character varying NOT NULL, -- e.g., Consumable, Weapon, Armor
    
    -- *** CORRECTED COLUMN DEFINITION (equip_slot) ***
    equip_slot character varying, -- e.g., Head, Weapon_MainHand (NULL if not equippable)
    
    rarity character varying DEFAULT 'Common'::character varying NOT NULL,
    effects jsonb, -- e.g., {"health_restore": 25}
    stats jsonb -- e.g., {"attackPower": 5}
);

-- Table structure for hosg_skill_templates
CREATE TABLE IF NOT EXISTS public.hosg_skill_templates (
    id integer NOT NULL PRIMARY KEY,
    code character varying NOT NULL,
    name character varying NOT NULL,
    description text,
    skill_type character varying NOT NULL, -- e.g., Physical, Magic, Utility
    cooldown_ms integer DEFAULT 0 NOT NULL,
    resource_cost jsonb, -- e.g., {"mana": 10, "stamina": 0}
    effect jsonb -- e.g., {"type": "damage", "base_value": 15, "magic_scaling": 0.5}
);

-- Table structure for hosg_npc_templates
CREATE TABLE IF NOT EXISTS public.hosg_npc_templates (
    id integer NOT NULL PRIMARY KEY,
    code character varying NOT NULL,
    name character varying NOT NULL,
    level integer DEFAULT 1 NOT NULL,
    faction character varying DEFAULT 'neutral'::character varying NOT NULL, 
    stats jsonb, -- e.g., {"maxHealth": 50, "attackPower": 8, "moveSpeed": 3.0}
    ai_profile character varying DEFAULT 'aggro'::character varying NOT NULL,
    loot_table jsonb -- e.g., {"gold": [1, 3], "items": [{"item_template_id": 1001, "chance": 0.5, "quantity": [1, 2]}]}
);

-- Table structure for hosg_npc_spawns
CREATE TABLE IF NOT EXISTS public.hosg_npc_spawns (
    id SERIAL PRIMARY KEY,
    npc_template_id integer NOT NULL REFERENCES public.hosg_npc_templates(id),
    zone_id integer DEFAULT 1 NOT NULL,
    position_x numeric DEFAULT 0 NOT NULL,
    position_y numeric DEFAULT 0 NOT NULL,
    position_z numeric DEFAULT 0 NOT NULL,
    respawn_seconds integer DEFAULT 60 NOT NULL,
    max_spawn integer DEFAULT 1 NOT NULL,
    spawn_radius numeric DEFAULT 5.0 NOT NULL
);

-- Table structure for hosg_characters (Player persistence)
CREATE TABLE IF NOT EXISTS public.hosg_characters (
    id uuid NOT NULL PRIMARY KEY,
    user_id uuid, -- Link to auth.users if needed
    name character varying NOT NULL,
    level integer DEFAULT 1 NOT NULL,
    
    -- Current position and rotation
    position_x numeric DEFAULT 0 NOT NULL,
    position_y numeric DEFAULT 0 NOT NULL,
    position_z numeric DEFAULT 0 NOT NULL,
    rotation_y numeric DEFAULT 0 NOT NULL,
    
    -- Current Resources
    health numeric DEFAULT 100 NOT NULL,
    mana numeric DEFAULT 50 NOT NULL,
    stamina numeric DEFAULT 100 NOT NULL,

    -- All stats (Max values + modifers)
    stats jsonb -- e.g., {"maxHealth": 100, "attackPower": 10}
);

-- Table structure for hosg_character_items (Inventory)
CREATE TABLE IF NOT EXISTS public.hosg_character_items (
    id SERIAL PRIMARY KEY,
    character_id uuid NOT NULL REFERENCES public.hosg_characters(id),
    item_template_id integer NOT NULL REFERENCES public.hosg_item_templates(id),
    quantity integer DEFAULT 1 NOT NULL,
    slot_index integer NOT NULL, -- Slot index in the player's inventory array
    location_type character varying DEFAULT 'inventory'::character varying NOT NULL
);

-- Table structure for hosg_character_equipment
CREATE TABLE IF NOT EXISTS public.hosg_character_equipment (
    id SERIAL PRIMARY KEY,
    character_id uuid NOT NULL REFERENCES public.hosg_characters(id),
    item_template_id integer NOT NULL REFERENCES public.hosg_item_templates(id),
    equip_slot character varying NOT NULL -- e.g., Weapon_MainHand, Head
);

-- Table structure for hosg_character_skills
CREATE TABLE IF NOT EXISTS public.hosg_character_skills (
    id SERIAL PRIMARY KEY,
    character_id uuid NOT NULL REFERENCES public.hosg_characters(id),
    skill_id integer NOT NULL REFERENCES public.hosg_skill_templates(id)
);


--
-- STEP 3: TEST DATA INSERTS
--

-- 1. Item Templates
INSERT INTO public.hosg_item_templates (id, code, name, description, item_type, equip_slot, rarity, effects, stats) VALUES
(1001, 'wolf_pelt', 'Wolf Pelt', 'A durable hide from a Dire Wolf.', 'Material', NULL, 'Common', '{}'::jsonb, '{}'::jsonb),
(1002, 'minor_health_potion', 'Minor Health Potion', 'Restores a small amount of health.', 'Consumable', NULL, 'Common', '{"health_restore": 25}'::jsonb, '{}'::jsonb),
(1003, 'wooden_sword', 'Wooden Practice Sword', 'A basic weapon for beginners.', 'Weapon', 'Weapon_MainHand', 'Common', '{}'::jsonb, '{"attackPower": 5}'::jsonb);

-- 2. Skill Templates
INSERT INTO public.hosg_skill_templates (id, code, name, description, skill_type, cooldown_ms, resource_cost, effect) VALUES
(1, 'fireball', 'Fireball', 'Launches a basic fire projectile at the target.', 'Magic', 3000, '{"mana": 15}'::jsonb, '{"type": "damage", "requiresTarget": true, "base_value": 10, "magic_scaling": 0.8}'::jsonb),
(2, 'heal', 'Minor Heal', 'Restores a small amount of the caster''s health.', 'Utility', 5000, '{"mana": 10}'::jsonb, '{"type": "heal", "requiresTarget": false, "base_value": 30}'::jsonb);

-- 3. NPC/Enemy Templates
INSERT INTO public.hosg_npc_templates (id, code, name, level, faction, stats, ai_profile, loot_table) VALUES
(101, 'dire_wolf', 'Dire Wolf', 3, 'monster', '{"maxHealth": 50, "attackPower": 8, "moveSpeed": 3.0}'::jsonb, 'aggro', '{"gold": [1, 3], "items": [{"item_template_id": 1001, "chance": 0.8, "quantity": [1, 2]}]}'::jsonb);

-- 4. NPC Spawns
INSERT INTO public.hosg_npc_spawns (npc_template_id, zone_id, position_x, position_y, position_z, respawn_seconds, max_spawn, spawn_radius) VALUES
(101, 1, 20.0, 0.0, 20.0, 60, 2, 5.0);

-- 5. Test Character
INSERT INTO public.hosg_characters (id, name, level, position_x, position_y, position_z, rotation_y, health, mana, stamina, stats) VALUES
('a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 'Arden Stonehand', 5, 0.0, 20.0, 0.0, 0.0, 85.0, 40.0, 90.0, '{"maxHealth": 120, "maxMana": 60, "maxStamina": 110, "attackPower": 15, "magicPower": 8}'::jsonb);

-- 6. Character Inventory
INSERT INTO public.hosg_character_items (character_id, item_template_id, quantity, slot_index, location_type) VALUES
('a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 1002, 5, 0, 'inventory'), -- 5x Health Potions in slot 0
('a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 1001, 12, 1, 'inventory'); -- 12x Wolf Pelts in slot 1

-- 7. Character Equipment
INSERT INTO public.hosg_character_equipment (character_id, item_template_id, equip_slot) VALUES
('a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 1003, 'Weapon_MainHand'); -- Wooden Sword equipped

-- 8. Character Skills
INSERT INTO public.hosg_character_skills (character_id, skill_id) VALUES
('a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 1), -- Fireball
('a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 2); -- Minor Heal
