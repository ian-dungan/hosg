<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Heroes of Shady Grove</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Make Supabase config available before our own scripts
    window.SUPABASE_CONFIG = {
      url: 'https://vaxfoafjjybwcxwhicla.supabase.co',
      key: 'sb_publishable_zFmHKiJYok_bNJSjUL4DOA_h6XCC1YD'
    };
  </script>

  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #renderCanvas {
      width: 100%;
      height: 100%;
      touch-action: none;
    }
  </style>
</head>
<body>
  <canvas id="renderCanvas"></canvas>

  <script>
    // Minimal loading text helper to avoid missing function errors during bootstrap
    (function () {
      function ensureLoadingElement() {
        var el = document.getElementById('loadingText');
        if (!el) {
          el = document.createElement('div');
          el.id = 'loadingText';
          el.style.position = 'absolute';
          el.style.top = '8px';
          el.style.left = '8px';
          el.style.padding = '6px 10px';
          el.style.background = 'rgba(0, 0, 0, 0.5)';
          el.style.color = '#fff';
          el.style.fontFamily = 'Arial, sans-serif';
          el.style.fontSize = '14px';
          el.style.borderRadius = '4px';
          el.style.pointerEvents = 'none';
          document.body.appendChild(el);
        }
        return el;
      }

      window.updateLoadingText = function (message) {
        try {
          var el = ensureLoadingElement();
          el.textContent = message || '';
        } catch (err) {
          console.warn('[Bootstrap] updateLoadingText fallback failed:', err);
        }
      };
    })();
  </script>

<script src="js/core.js"></script>
<script src="js/assets.js"></script>
<script src="js/item.js"></script>
<script src="js/ability.js"></script>
<script src="js/world.js"></script>
<script src="js/player.js"></script>
<script src="js/ui.js"></script>
<script src="js/network.js"></script>
<script src="js/game.js"></script>
  
  <script>
    async function initializeGame() {
        console.log("[Bootstrap] Starting game initialization sequence...");

        if (typeof NetworkManager === "undefined") {
            console.warn("[Bootstrap] Network script missing. Using offline template fallback.");
            window.NetworkManager = function () {
                this.loadTemplates = function (itemMap, skillMap, npcMap) {
                    const fallbackSkills = [{
                        id: 'Cleave',
                        code: 'CLEAVE',
                        name: 'Cleave',
                        skill_type: 'Attack',
                        resource_cost: { mana: 0, stamina: 10 },
                        cooldown_ms: 5000,
                        effect: { type: 'damage', base_value: 10, magic_scaling: 0, physical_scaling: 0.5 }
                    }];

                    fallbackSkills.forEach((t) => skillMap.set(t.id, t));
                    return Promise.resolve(true);
                };
            };
        }

        // 1. Setup Babylon.js Engine and Scene
        const canvas = document.getElementById("renderCanvas");
        if (!canvas) {
            console.error("[Bootstrap] Canvas element 'renderCanvas' not found.");
            return;
        }

        const engine = new BABYLON.Engine(canvas, true);
        const scene = new BABYLON.Scene(engine);
        
        scene.collisionsEnabled = true;
        // Use CONFIG value if available, default to 9.81
        const GRAVITY = (typeof CONFIG !== 'undefined' && CONFIG.GAME) ? CONFIG.GAME.GRAVITY : 9.81;
        scene.gravity = new BABYLON.Vector3(0, -GRAVITY, 0);
        scene.enablePhysics(scene.gravity, new BABYLON.CannonJSPlugin());

        // 2. Instantiate Base Managers
        const uiManager = new UIManager(scene);
        const networkManager = new NetworkManager(); 
        const assetManager = new AssetManager(scene);

        // 3. Create Game Orchestrator and LINK CRITICAL DEPENDENCIES (THE FIX)
        // Pass null for World/Player initially.
        const game = new Game(engine, scene, null, null, uiManager); 
        scene.game = game;                  // CRITICAL: Link game to scene
        game.assetManager = assetManager;   // CRITICAL: Link assetManager to game
        game.network = networkManager;      // Link network manager

        // 4. Template Loading Sequence
        const itemTemplates = new Map();
        const skillTemplates = new Map();
        const npcTemplates = new Map();
        
        console.log("[Bootstrap] Loading templates from Network...");
        const templatesLoaded = await networkManager.loadTemplates(itemTemplates, skillTemplates, npcTemplates);
        
        if (!templatesLoaded) {
            console.error("[Bootstrap] Failed to load essential game templates. Halting.");
            return;
        }
        
        // Attach templates to game
        game.itemTemplates = itemTemplates;
        game.skillTemplates = skillTemplates;
        game.npcTemplates = npcTemplates;
        
        // 5. Load all visual assets (models, textures)
        console.log("[Bootstrap] Loading all game assets (models, textures)...");
        await assetManager.loadAll();
        assetManager.printStats();
        console.log("[Bootstrap] All assets loaded.");
        
        // 6. Create Player and World (Now safe to instantiate)
        // The Player constructor calls applyClass, which now successfully finds game.assetManager.
        const player = new Player(scene);
        const world = new World(scene, player);
        
        // 7. Finalize Game Orchestrator
        game.player = player; 
        game.world = world;
        
        // REMOVED REDUNDANT CALLS: The Player constructor handles applyClass/initMesh now.
        // player.assetManager = assetManager; // No longer needed, as it's on game
        // world.assetManager = assetManager;  // No longer needed, as it's on game
        // player.applyDefaultClass('Warrior');
        // player._initMesh();

        game.init(); 
        uiManager.init(); 

        // 8. Build the World
        world.createEnvironment(assetManager); 
        
        // 9. Start the Game
        game.run(); 
        console.log("[Bootstrap] Game started successfully.");

        // Handle window resize events
        window.addEventListener("resize", () => {
            engine.resize();
        });
    }

    initializeGame();
</script>

</body>
</html>
