<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Heroes of Shady Grove</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; }
    #renderCanvas { width: 100%; height: 100%; touch-action: none; outline: none; }
    #loadingText { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      color: white; 
      font-family: 'Arial', sans-serif;
      font-size: 24px;
      pointer-events: none;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
  </style>
</head>
<body>

  <script>
    // Minimal loading text helper to avoid missing function errors during bootstrap
    (function () {
      function ensureLoadingElement() {
        var el = document.getElementById('loadingText');
        if (!el) {
          el = document.createElement('div');
          el.id = 'loadingText';
          el.style.position = 'absolute';
          el.style.top = '8px';
          el.style.left = '8px';
          el.style.padding = '6px 10px';
          el.style.background = 'rgba(0, 0, 0, 0.5)';
          el.style.color = '#fff';
          el.style.fontFamily = 'Arial, sans-serif';
          el.style.fontSize = '14px';
          el.style.borderRadius = '4px';
          el.style.pointerEvents = 'none';
          document.body.appendChild(el);
        }
        return el;
      }

      window.updateLoadingText = function (message) {
        try {
          var el = ensureLoadingElement();
          el.textContent = message || '';
        } catch (err) {
          console.warn('[Bootstrap] updateLoadingText fallback failed:', err);
        }
      };
    })();
  </script>

  <script>
    // Minimal loading text helper to avoid missing function errors during bootstrap
    (function () {
      function ensureLoadingElement() {
        var el = document.getElementById('loadingText');
        if (!el) {
          el = document.createElement('div');
          el.id = 'loadingText';
          el.style.position = 'absolute';
          el.style.top = '8px';
          el.style.left = '8px';
          el.style.padding = '6px 10px';
          el.style.background = 'rgba(0, 0, 0, 0.5)';
          el.style.color = '#fff';
          el.style.fontFamily = 'Arial, sans-serif';
          el.style.fontSize = '14px';
          el.style.borderRadius = '4px';
          el.style.pointerEvents = 'none';
          document.body.appendChild(el);
        }
        return el;
      }

      window.updateLoadingText = function (message) {
        try {
          var el = ensureLoadingElement();
          el.textContent = message || '';
        } catch (err) {
          console.warn('[Bootstrap] updateLoadingText fallback failed:', err);
        }
      };
    })();
  </script>

  <script>
    // Minimal loading text helper to avoid missing function errors during bootstrap
    (function () {
      function ensureLoadingElement() {
        var el = document.getElementById('loadingText');
        if (!el) {
          el = document.createElement('div');
          el.id = 'loadingText';
          el.style.position = 'absolute';
          el.style.top = '8px';
          el.style.left = '8px';
          el.style.padding = '6px 10px';
          el.style.background = 'rgba(0, 0, 0, 0.5)';
          el.style.color = '#fff';
          el.style.fontFamily = 'Arial, sans-serif';
          el.style.fontSize = '14px';
          el.style.borderRadius = '4px';
          el.style.pointerEvents = 'none';
          document.body.appendChild(el);
        }
        return el;
      }

      window.updateLoadingText = function (message) {
        try {
          var el = ensureLoadingElement();
          el.textContent = message || '';
        } catch (err) {
          console.warn('[Bootstrap] updateLoadingText fallback failed:', err);
        }
      };
    })();
  </script>

  <script>
    // Utility helpers that must exist before bootstrap executes
    (function () {
      function ensureLoadingElement() {
        var el = document.getElementById('loadingText');
        if (!el) {
          el = document.createElement('div');
          el.id = 'loadingText';
          el.style.position = 'absolute';
          el.style.top = '8px';
          el.style.left = '8px';
          el.style.padding = '6px 10px';
          el.style.background = 'rgba(0, 0, 0, 0.5)';
          el.style.color = '#fff';
          el.style.fontFamily = 'Arial, sans-serif';
          el.style.fontSize = '14px';
          el.style.borderRadius = '4px';
          el.style.pointerEvents = 'none';
          document.body.appendChild(el);
        }
        return el;
      }

      window.updateLoadingText = function (message) {
        try {
          var el = ensureLoadingElement();
          el.textContent = message || '';
        } catch (err) {
          console.warn('[Bootstrap] updateLoadingText fallback failed:', err);
        }
      };

      // Ensure a render canvas exists and keep a reference on window for scripts that run early
      window.ensureRenderCanvas = function () {
        var canvas = document.getElementById('renderCanvas');
        if (!canvas) {
          console.warn("[Bootstrap] Canvas element 'renderCanvas' not found. Creating one dynamically.");
          canvas = document.createElement('canvas');
          canvas.id = 'renderCanvas';
          canvas.style.width = '100%';
          canvas.style.height = '100%';
          canvas.style.touchAction = 'none';
          document.body.appendChild(canvas);
        }

        // Some environments access window.renderCanvas directly; keep it updated
        window.renderCanvas = canvas;
        return canvas;
      };
    })();
  </script>

  <script>
    // Utility helpers that must exist before bootstrap executes
    (function () {
      function ensureLoadingElement() {
        var el = document.getElementById('loadingText');
        if (!el) {
          el = document.createElement('div');
          el.id = 'loadingText';
          el.style.position = 'absolute';
          el.style.top = '8px';
          el.style.left = '8px';
          el.style.padding = '6px 10px';
          el.style.background = 'rgba(0, 0, 0, 0.5)';
          el.style.color = '#fff';
          el.style.fontFamily = 'Arial, sans-serif';
          el.style.fontSize = '14px';
          el.style.borderRadius = '4px';
          el.style.pointerEvents = 'none';
          document.body.appendChild(el);
        }
        return el;
      }

      window.updateLoadingText = function (message) {
        try {
          var el = ensureLoadingElement();
          el.textContent = message || '';
        } catch (err) {
          console.warn('[Bootstrap] updateLoadingText fallback failed:', err);
        }
      };

      // Ensure a render canvas exists and keep a reference on window for scripts that run early
      window.ensureRenderCanvas = function () {
        // In some constrained environments document.body may not be ready yet; create one if needed.
        if (!document.body) {
          var body = document.createElement('body');
          document.documentElement.appendChild(body);
        }

        var canvas = document.getElementById('renderCanvas');
        if (!canvas) {
          console.warn("[Bootstrap] Canvas element 'renderCanvas' not found. Creating one dynamically.");
          canvas = document.createElement('canvas');
          canvas.id = 'renderCanvas';
          canvas.style.width = '100%';
          canvas.style.height = '100%';
          canvas.style.touchAction = 'none';
          document.body.appendChild(canvas);
        }

        // Some environments access window.renderCanvas directly; keep it updated
        window.renderCanvas = canvas;
        return canvas;
      };
    })();
  </script>

  <script>
    // Utility helpers that must exist before bootstrap executes
    (function () {
      function ensureLoadingElement() {
        var el = document.getElementById('loadingText');
        if (!el) {
          el = document.createElement('div');
          el.id = 'loadingText';
          el.style.position = 'absolute';
          el.style.top = '8px';
          el.style.left = '8px';
          el.style.padding = '6px 10px';
          el.style.background = 'rgba(0, 0, 0, 0.5)';
          el.style.color = '#fff';
          el.style.fontFamily = 'Arial, sans-serif';
          el.style.fontSize = '14px';
          el.style.borderRadius = '4px';
          el.style.pointerEvents = 'none';
          document.body.appendChild(el);
        }
        return el;
      }

      window.updateLoadingText = function (message) {
        try {
          var el = ensureLoadingElement();
          el.textContent = message || '';
        } catch (err) {
          console.warn('[Bootstrap] updateLoadingText fallback failed:', err);
        }
      };

      // Ensure a render canvas exists and keep a reference on window for scripts that run early
      window.ensureRenderCanvas = function () {
        // In some constrained environments document.body may not be ready yet; create one if needed.
        if (!document.body) {
          var body = document.createElement('body');
          document.documentElement.appendChild(body);
        }

        var canvas = document.getElementById('renderCanvas');
        if (!canvas) {
          console.warn("[Bootstrap] Canvas element 'renderCanvas' not found. Creating one dynamically.");
          canvas = document.createElement('canvas');
          canvas.id = 'renderCanvas';
          canvas.style.width = '100%';
          canvas.style.height = '100%';
          canvas.style.touchAction = 'none';
          document.body.appendChild(canvas);
        }

        // Some environments access window.renderCanvas directly; keep it updated
        window.renderCanvas = canvas;
        return canvas;
      };
    })();
  </script>

  <script>
    // Utility helpers that must exist before bootstrap executes
    (function () {
      function ensureLoadingElement() {
        var el = document.getElementById('loadingText');
        if (!el) {
          el = document.createElement('div');
          el.id = 'loadingText';
          el.style.position = 'absolute';
          el.style.top = '8px';
          el.style.left = '8px';
          el.style.padding = '6px 10px';
          el.style.background = 'rgba(0, 0, 0, 0.5)';
          el.style.color = '#fff';
          el.style.fontFamily = 'Arial, sans-serif';
          el.style.fontSize = '14px';
          el.style.borderRadius = '4px';
          el.style.pointerEvents = 'none';
          document.body.appendChild(el);
        }
        return el;
      }

      window.updateLoadingText = function (message) {
        try {
          var el = ensureLoadingElement();
          el.textContent = message || '';
        } catch (err) {
          console.warn('[Bootstrap] updateLoadingText fallback failed:', err);
        }
      };

      // Ensure a render canvas exists and keep a reference on window for scripts that run early
      window.ensureRenderCanvas = function () {
        // In some constrained environments document.body may not be ready yet; create one if needed.
        if (!document.body) {
          var body = document.createElement('body');
          document.documentElement.appendChild(body);
        }

        var canvas = document.getElementById('renderCanvas');
        if (!canvas) {
          console.warn("[Bootstrap] Canvas element 'renderCanvas' not found. Creating one dynamically.");
          canvas = document.createElement('canvas');
          canvas.id = 'renderCanvas';
          canvas.style.width = '100%';
          canvas.style.height = '100%';
          canvas.style.touchAction = 'none';
          document.body.appendChild(canvas);
        }

        // Some environments access window.renderCanvas directly; keep it updated
        window.renderCanvas = canvas;
        return canvas;
      };
    })();
  </script>

  <script>
    // Utility helpers that must exist before bootstrap executes
    (function () {
      function ensureLoadingElement() {
        var el = document.getElementById('loadingText');
        if (!el) {
          el = document.createElement('div');
          el.id = 'loadingText';
          el.style.position = 'absolute';
          el.style.top = '8px';
          el.style.left = '8px';
          el.style.padding = '6px 10px';
          el.style.background = 'rgba(0, 0, 0, 0.5)';
          el.style.color = '#fff';
          el.style.fontFamily = 'Arial, sans-serif';
          el.style.fontSize = '14px';
          el.style.borderRadius = '4px';
          el.style.pointerEvents = 'none';
          document.body.appendChild(el);
        }
        return el;
      }

      window.updateLoadingText = function (message) {
        try {
          var el = ensureLoadingElement();
          el.textContent = message || '';
        } catch (err) {
          console.warn('[Bootstrap] updateLoadingText fallback failed:', err);
        }
      };

      // Ensure a render canvas exists and keep a reference on window for scripts that run early
      window.ensureRenderCanvas = function () {
        // In some constrained environments document.body may not be ready yet; create one if needed.
        if (!document.body) {
          var body = document.createElement('body');
          document.documentElement.appendChild(body);
        }

        var canvas = document.getElementById('renderCanvas');
        if (!canvas) {
          console.warn("[Bootstrap] Canvas element 'renderCanvas' not found. Creating one dynamically.");
          canvas = document.createElement('canvas');
          canvas.id = 'renderCanvas';
          canvas.style.width = '100%';
          canvas.style.height = '100%';
          canvas.style.touchAction = 'none';
          document.body.appendChild(canvas);
        }

        // Some environments access window.renderCanvas directly; keep it updated
        window.renderCanvas = canvas;
        return canvas;
      };
    })();
  </script>

  <script>
    // Utility helpers that must exist before bootstrap executes
    (function () {
      function ensureLoadingElement() {
        var el = document.getElementById('loadingText');
        if (!el) {
          el = document.createElement('div');
          el.id = 'loadingText';
          el.style.position = 'absolute';
          el.style.top = '8px';
          el.style.left = '8px';
          el.style.padding = '6px 10px';
          el.style.background = 'rgba(0, 0, 0, 0.5)';
          el.style.color = '#fff';
          el.style.fontFamily = 'Arial, sans-serif';
          el.style.fontSize = '14px';
          el.style.borderRadius = '4px';
          el.style.pointerEvents = 'none';
          document.body.appendChild(el);
        }
        return el;
      }

      window.updateLoadingText = function (message) {
        try {
          var el = ensureLoadingElement();
          el.textContent = message || '';
        } catch (err) {
          console.warn('[Bootstrap] updateLoadingText fallback failed:', err);
        }
      };

      // Ensure a render canvas exists and keep a reference on window for scripts that run early
      window.ensureRenderCanvas = function () {
        // In some constrained environments document.body may not be ready yet; create one if needed.
        if (!document.body) {
          var body = document.createElement('body');
          document.documentElement.appendChild(body);
        }

        var canvas = document.getElementById('renderCanvas');
        if (!canvas) {
          console.warn("[Bootstrap] Canvas element 'renderCanvas' not found. Creating one dynamically.");
          canvas = document.createElement('canvas');
          canvas.id = 'renderCanvas';
          canvas.style.width = '100%';
          canvas.style.height = '100%';
          canvas.style.touchAction = 'none';
          document.body.appendChild(canvas);
        }

        // Some environments access window.renderCanvas directly; keep it updated
        window.renderCanvas = canvas;
        return canvas;
      };
    })();
  </script>

  <script>
    // Utility helpers that must exist before bootstrap executes
    (function () {
      function ensureLoadingElement() {
        var el = document.getElementById('loadingText');
        if (!el) {
          el = document.createElement('div');
          el.id = 'loadingText';
          el.style.position = 'absolute';
          el.style.top = '8px';
          el.style.left = '8px';
          el.style.padding = '6px 10px';
          el.style.background = 'rgba(0, 0, 0, 0.5)';
          el.style.color = '#fff';
          el.style.fontFamily = 'Arial, sans-serif';
          el.style.fontSize = '14px';
          el.style.borderRadius = '4px';
          el.style.pointerEvents = 'none';
          document.body.appendChild(el);
        }
        return el;
      }

      window.updateLoadingText = function (message) {
        try {
          var el = ensureLoadingElement();
          el.textContent = message || '';
        } catch (err) {
          console.warn('[Bootstrap] updateLoadingText fallback failed:', err);
        }
      };

      // Ensure a render canvas exists and keep a reference on window for scripts that run early
      window.ensureRenderCanvas = function () {
        // In some constrained environments document.body may not be ready yet; create one if needed.
        if (!document.body) {
          var body = document.createElement('body');
          document.documentElement.appendChild(body);
        }

        var canvas = document.getElementById('renderCanvas');
        if (!canvas) {
          console.warn("[Bootstrap] Canvas element 'renderCanvas' not found. Creating one dynamically.");
          canvas = document.createElement('canvas');
          canvas.id = 'renderCanvas';
          canvas.style.width = '100%';
          canvas.style.height = '100%';
          canvas.style.touchAction = 'none';
          document.body.appendChild(canvas);
        }

        // Some environments access window.renderCanvas directly; keep it updated
        window.renderCanvas = canvas;
        return canvas;
      };
    })();
  </script>

<script src="js/core.js"></script>
<script src="js/item.js"></script>
<script src="js/ability.js"></script>
<script src="js/assets.js"></script>
<script src="js/network.js"></script>
<script src="js/world.js"></script>
<script src="js/player.js"></script>
<script src="js/ui.js"></script>
<script src="js/game.js"></script>
  
  <script>
    function initializeGame() {
        try {
            console.log("[Bootstrap] Starting game initialization sequence...");

            if (typeof NetworkManager === "undefined") {
                console.warn("[Bootstrap] Network script missing. Using offline template fallback.");
                window.NetworkManager = function () {
                    this.loadTemplates = function (itemMap, skillMap, npcMap) {
                        var fallbackSkills = [{
                            id: 'Cleave',
                            code: 'CLEAVE',
                            name: 'Cleave',
                            skill_type: 'Attack',
                            resource_cost: { mana: 0, stamina: 10 },
                            cooldown_ms: 5000,
                            effect: { type: 'damage', base_value: 10, magic_scaling: 0, physical_scaling: 0.5 }
                        }];

                        fallbackSkills.forEach(function (t) { return skillMap.set(t.id, t); });
                        return Promise.resolve(true);
                    };
                };
            }

            // 1. Setup Babylon.js Engine and Scene
            var canvas = (typeof window.ensureRenderCanvas === 'function')
                ? window.ensureRenderCanvas()
                : document.getElementById("renderCanvas");

            var engine = new BABYLON.Engine(canvas, true);
            var scene = new BABYLON.Scene(engine);
            window.engine = engine;
            window.scene = scene;

            scene.collisionsEnabled = true;
            // Use CONFIG value if available, default to 9.81
            var GRAVITY = (typeof CONFIG !== 'undefined' && CONFIG.GAME) ? CONFIG.GAME.GRAVITY : 9.81;
            scene.gravity = new BABYLON.Vector3(0, -GRAVITY, 0);
            scene.enablePhysics(scene.gravity, new BABYLON.CannonJSPlugin());

            // 2. Instantiate Base Managers
            var uiManager = new UIManager(scene);
            var networkManager = new NetworkManager();
            var assetManager = new AssetManager(scene);

            // 3. Create Game Orchestrator and LINK CRITICAL DEPENDENCIES (THE FIX)
            // Pass null for World/Player initially.
            var game = new Game(engine, scene, null, null, uiManager);
            scene.game = game;                  // CRITICAL: Link game to scene
            game.assetManager = assetManager;   // CRITICAL: Link assetManager to game
            game.network = networkManager;      // Link network manager

            // 4. Template Loading Sequence
            var itemTemplates = new Map();
            var skillTemplates = new Map();
            var npcTemplates = new Map();

            console.log("[Bootstrap] Loading templates from Network...");
            var templatesLoadedPromise = networkManager.loadTemplates(itemTemplates, skillTemplates, npcTemplates);

            Promise.resolve(templatesLoadedPromise).then(function (templatesLoaded) {
                if (!templatesLoaded) {
                    console.error("[Bootstrap] Failed to load essential game templates. Halting.");
                    return;
                }

                // Attach templates to game
                game.itemTemplates = itemTemplates;
                game.skillTemplates = skillTemplates;
                game.npcTemplates = npcTemplates;

                // 5. Load all visual assets (models, textures)
                console.log("[Bootstrap] Loading all game assets (models, textures)...");
                return assetManager.loadAll().then(function () {
                    assetManager.printStats();
                    console.log("[Bootstrap] All assets loaded.");

                    // 6. Create Player and World (Now safe to instantiate)
                    // The Player constructor calls applyClass, which now successfully finds game.assetManager.
                    var player = new Player(scene);
                    var world = new World(scene, player);

                    // 7. Finalize Game Orchestrator
                    game.player = player;
                    game.world = world;

                    game.init();
                    uiManager.init();

                    // 8. Build the World
                    world.createEnvironment(assetManager);

                    // 9. Start the Game
                    game.run();
                    console.log("[Bootstrap] Game started successfully.");
                });
            }).catch(function (err) {
                console.error('[Bootstrap] FATAL ERROR during initialization:', err);
            });

            // Handle window resize events
            window.addEventListener("resize", function () {
                engine.resize();
            });
        } catch (err) {
            console.error('[Bootstrap] FATAL ERROR before async init:', err);
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeGame);
    } else {
        initializeGame();
    }
</script>

    // Start when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeGame);
    } else {
        initializeGame();
    }
</script>
</body>
</html>
