<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Heroes of Shady Grove</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; }
    #renderCanvas { width: 100%; height: 100%; touch-action: none; outline: none; }
    #loadingText { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      color: white; 
      font-family: 'Arial', sans-serif;
      font-size: 24px;
      pointer-events: none;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
  </style>
</head>
<body>

<canvas id="renderCanvas"></canvas>
<div id="loadingText">Loading Heroes of Shady Grove...</div>

<!-- Load scripts in proper dependency order -->
<script src="js/core.js"></script>
<script src="js/item.js"></script>
<script src="js/ability.js"></script>
<script src="js/assets.js"></script>
<script src="js/network.js"></script>
<script src="js/world.js"></script>
<script src="js/player.js"></script>
<script src="js/ui.js"></script>
<script src="js/game.js"></script>
  
  <script>
    async function initializeGame() {
        console.log("[Bootstrap] Starting game initialization sequence...");

        if (typeof NetworkManager === "undefined") {
            console.warn("[Bootstrap] Network script missing. Using offline template fallback.");
            window.NetworkManager = function () {
                this.loadTemplates = function (itemMap, skillMap, npcMap) {
                    const fallbackSkills = [{
                        id: 'Cleave',
                        code: 'CLEAVE',
                        name: 'Cleave',
                        skill_type: 'Attack',
                        resource_cost: { mana: 0, stamina: 10 },
                        cooldown_ms: 5000,
                        effect: { type: 'damage', base_value: 10, magic_scaling: 0, physical_scaling: 0.5 }
                    }];

                    fallbackSkills.forEach((t) => skillMap.set(t.id, t));
                    return Promise.resolve(true);
                };
            };
        }

        // 1. Setup Babylon.js Engine and Scene
        const canvas = document.getElementById("renderCanvas");
        if (!canvas) {
            console.error("[Bootstrap] Canvas element 'renderCanvas' not found.");
            return;
        }
    }

    async function initializeGame() {
        try {
            console.log("[Bootstrap] Starting initialization...");
            updateLoadingText("Initializing Core Systems...");

            // 1. Verify Scripts Loaded
            const requiredClasses = ['Game', 'UIManager', 'Player', 'World', 'AssetManager', 'Character', 'Enemy'];
            const missing = requiredClasses.filter(cls => typeof window[cls] === 'undefined');
            
            if (missing.length > 0) {
                throw new Error(`Critical scripts failed to load: ${missing.join(', ')}. Check console for errors.`);
            }

            // 2. Setup Core Managers
            const uiManager = new UIManager(scene);
            const assetManager = new AssetManager(scene);
            
            // Create game instance (without player/world yet)
            const game = new Game(engine, scene, null, null, uiManager);
            scene.game = game; 
            game.assetManager = assetManager;

            // 3. Load Network Templates
            updateLoadingText("Loading Game Data...");
            const skillTemplates = new Map();
            const npcTemplates = new Map();
            
            if (typeof SupabaseService !== 'undefined') {
                const network = new SupabaseService();
                await network.loadTemplates(skillTemplates, npcTemplates);
            } else {
                console.warn("[Bootstrap] Network script missing.");
            }

            game.skillTemplates = skillTemplates;
            game.npcTemplates = npcTemplates;
            
            // 4. Load Assets
            updateLoadingText("Loading 3D Assets...");
            await assetManager.loadAll();
            
            // 5. Create World FIRST (this creates camera and environment)
            updateLoadingText("Creating World...");
            const world = new World(scene, null); // Player not created yet
            world.createEnvironment(assetManager);
            game.world = world;
            
            // 6. NOW create Player and link camera
            updateLoadingText("Creating Player...");
            const spawnPos = new BABYLON.Vector3(0, CONFIG.PLAYER.SPAWN_HEIGHT || 5, 0);
            const player = new Player(scene, spawnPos, 'Warrior');
            
            // Link player to world
            world.player = player;
            game.player = player;
            
            // Initialize player's camera (now that world camera exists)
            player.initCamera(world.camera);
            
            // 7. Initialize UI
            updateLoadingText("Setting up Interface...");
            uiManager.init();
            
            // 8. Launch Game
            updateLoadingText("Starting Adventure...");
            game.init();
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById("loadingText").style.display = "none";
                game.run();
                console.log("[Bootstrap] Game running successfully!");
            }, 500);

        } catch (error) {
            console.error("[Bootstrap] FATAL ERROR:", error);
            updateLoadingText("Error: " + error.message);
            document.getElementById("loadingText").style.color = "red";
        }
    }

    // Handle Resize
    window.addEventListener("resize", () => {
        if (engine) {
            engine.resize();
        }
    });

    // Start when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeGame);
    } else {
        initializeGame();
    }
</script>
</body>
</html>
